# Настройка ViPNet и InfoWatch: Ключевые моменты

гайд сгенерен нейронкой Grok, сгрузив туда важные методички по InfoWatch и vipnet. по факту, это просто краткий пересказ тех методичек с упоминанием важных моментов.
оглавление

оглавление:
настройка випнет на 110 строке
настройка випнет по гитхабовской (крутой) методичке на 153 строке

1. Настройка Active Directory и ALD Pro

1.1. Создание структуры AD
Создавайте подразделение FinalOfficeAD в demo.lab: правая кнопка мыши > создать > подразделение, убирайте флажок защиты.
Добавляйте каталоги Users и Computers в FinalOfficeAD тем же способом.
Создавайте пользователей в Users: правая кнопка мыши > создать > пользователь, задавайте имя (например, Imofficer), пароль, убирайте флажки.

1.2. Добавление в группу администраторов
Добавляйте пользователей в Domain Admins: двойной клик по пользователю > вкладка "Член групп" > добавить > Domain Admins > ок, делайте основной группой.

1.3. Подготовка к синхронизации с ALD Pro
Редактируйте файл C:\Windows\System32\drivers\etc\hosts от имени администратора, добавляйте IP контроллера домена aldpro.lab (например, 172.16.1.3 dc.aldpro.lab dc).

1.4. Конфигурация сетевых файлов
В /etc/hosts прописывайте: 172.16.1.3 dc.aldpro.lab dc.
В /etc/network/interfaces задавайте: auto eth0, iface eth0 inet static, address 172.16.1.3/24.

1.5. Установка ALD Pro
Устанавливайте сервер командой:
sudo aldpro-server-install -d aldpro.lab -n <имя_сервера> -p <пароль> --ip 172.16.1.3 --no-reboot.

1.6. Подготовка astra-cli для ввода в домен
Настраивайте соединение: nmui > изменить соединение > IPv4 вручную > задавайте настройки.
Меняйте hostname: hostnamectl set-hostname astra-cli.aldpro.lab.
В /etc/hosts добавляйте: 172.16.1.3 dc.aldpro.lab dc.
Задавайте приоритет в /etc/apt/preferences.d/aldpro.

1.7. Установка клиента и ввод в домен
Устанавливайте клиент: sudo DEBIAN_FRONTEND=noninteractive apt-get install -q -y aldpro-client.
Вводите в домен:
sudo /opt/rbta/aldpro/client/bin/aldproclient-installer -c aldpro.lab -u admin -p xxXX1234 -d astra-cli -i -f.

1.8. Настройка доверительных отношений
В веб-интерфейсе ALD Pro: управление доменом > интеграции с MS AD > новое подключение.
Указывайте demo.lab, ставьте галочки "доверительные отношения" и "миграция", учетная запись — администратор домена.

1.9. Миграция объектов
Запускайте миграцию: "сопоставление полей при миграции" > запустить миграцию, выбирайте FinalOfficeAD для переноса в aldpro.lab.
Проверяйте вход через astra-cli.aldpro.lab с пользователем useroffice и доменом aldpro.



2. Настройка InfoWatch Traffic Monitor (IWTM)

2.1. Подготовка к установке
Добавляйте установочные диски, вводите integrity level 63.
Создавайте директории: mkdir /media/cdrom0, mkdir /media/cdrom1, mkdir /media/cdrom2.
Монтируйте диски: mount /dev/sr0 /media/cdrom0, mount /dev/sr1 /media/cdrom1, mount /dev/sr2 /media/cdrom2.

2.2. Копирование и установка
Копируйте файлы в /root/: cp -r Astra/ /root/.
Устанавливайте сертификаты: dpkg -i <название файла.deb> из /media/cdrom0/pool/main/c/ca-certificates/.

2.3. Конфигурация файлов
В /etc/hosts добавляйте: 172.16.1.4 iutm.
В /etc/apt/sources.list указывайте: file:/media/cdrom0/ 1.1_x86-64 contrib main non-free.

2.4. Установка IWTM
Делайте файл исполняемым: chmod +x iutm-installer-7.7.2.136-astra-smolensk-1.7.
Запускайте установку: ./iutm-installer-7.7.2.136-astra-smolensk-1.7, оставляйте настройки по умолчанию.

2.5. Активация и настройка
Входите в веб-интерфейс: логин officer, пароль xxXX1234.
Активируйте лицензию: управление > лицензии > +, выбирайте файл лицензии.
Настраивайте LDAP-синхронизацию с AD: управление > ldap-синхронизация > +, IP сервера 172.16.1.3, запрос — aldpro.lab, учетная запись admin@aldpro.lab, запускайте синхронизацию.

2.6. Добавление пользователей
Добавляйте доменного пользователя: управление > управление доступом > пользователи > + > из LDAP, выбирайте сервер и имя пользователя.



3. Настройка InfoWatch Device Monitor (IWDM)

3.1. Конфигурация сетевых файлов
В /etc/hosts: 172.16.1.5 iwdm.
В /etc/network/interfaces: auto eth0, iface eth0 inet static, address 172.16.1.5, gateway 172.16.1.1.
В /etc/resolv.conf: nameserver 172.16.1.2.

3.2. Установка dotnet 6
Устанавливайте wget: sudo apt install wget.
Добавляйте ключ MS: wget -O https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc.gpg > /dev/null.
Загружайте репозиторий: sudo wget https://packages.microsoft.com/config/debian/10/prod.list -O /etc/apt/sources.list.d/microsoft-prod.list.
Обновляйте пакеты: sudo apt update.
Устанавливайте: sudo apt install dotnet-sdk-6.0.

3.3. Установка сертификата
Копируйте сертификат: sudo cp tmca.crt /usr/local/share/ca-certificates/tmca.crt.

3.4. Настройка IWDM
Создавайте задачу распространения агента в веб-интерфейсе: добавляйте компьютер, запускайте с учетной записью locadm.
Создавайте группу "Отдел 1" с политикой "Отдел 1", добавляйте компьютер с агентом.
Создавайте правило перехвата трафика и проверочную политику с текстовым объектом "проверочная политика", применяйте конфигурацию.

3.5. Проверка работоспособности
На astra-cli в браузере заходите на dlptest.com, отправляйте "проверочная политика".
Проверяйте события в IWTM: события > запустить запрос.



4. Настройка ViPNet

4.1. Предварительные шаги
Синхронизируйте время на всех ВМ.
Отключайте или настраивайте Firewall для взаимодействия между ВМ.

4.2. Установка SQL Server на Net1-Open
Устанавливайте SQL Server, выбирайте New SQL Server stand-alone installation.
Принимайте лицензию, выбирайте все функции, задавайте имя экземпляра WINNCCSQL.
Включайте Mixed Mode, задавайте пароль, включайте все параметры FILESTREAM.
Включайте TCP/IP: SQL Server Network Configuration > Protocols for WINNCCSQL > TCP/IP > Enabled: Yes, перезапускайте службу.

4.3. Установка ЦУС и УКЦ на Net1-AdminCA
Запускайте установщик ЦУС, указывайте сервер 172.16.1.3\WINNCCSQL, логин sa, пароль xxXX1234.

4.4. Создание структуры сети
В ЦУС создавайте координаторы: "Координаторы" > "Новый координатор", роль Coordinator HW-VA.
Создавайте межсерверные каналы: свойства координатора > "Межсерверные каналы" > добавить.
Создавайте клиентов: "Клиенты" > "Создать новый сетевой узел", выбирайте координатор, задавайте роль Registration Point для OperCA.
Создавайте пользователей: "Пользователи" > "Создать нового пользователя", связывайте их через "Связи с пользователями".

4.5. Выпуск сертификатов
В УКЦ: "Сетевые узлы" > выделите узлы > "Выдать новый дистрибутив ключей", задавайте пароль.
Инициализируйте координаторы: подключайте USB с дистрибутивом, настраивайте интерфейсы (Static IP, IP и маска по схеме).
Инициализируйте клиентов: в ViPNet Client > "Настройка" > "Установить ключи", указывайте путь к дистрибутиву.

4.6. Настройка фильтров
В ViPNet Client после установки на сервере ЦУС: "Сетевые фильтры" > "Фильтры открытой сети" > "Создать", действие — "Пропускать трафик", применяйте.

4.7. Межсетевое взаимодействие
В ЦУС: "Доверенные сети" > "Установить взаимодействие" > "Я инициатор", задавайте номер сети (например, 12845), имя (Сеть 2), выбирайте координатор.
В УКЦ создавайте асимметричный ключ: "Асимметричные мастер-ключи" > "Создать", экспортируйте и передавайте во вторую сеть.
Во второй сети: "Доверенные сети" > "Я принимаю файл", загружайте ключ, используйте его через "Межсетевые мастер-ключи" > "Использовать".
Связывайте пользователей: "Свойства пользователя" > "Связи с пользователями" > добавляйте из доверенной сети.

4.8. Туннелирование
На координаторах: "Туннелирование" > "Добавить", указывайте IP незащищенного узла, максимум туннелей — 30, применяйте.
Проверяйте пинг между узлами и журнал IP-пакетов через http://<ip-координатора>:8080 или iplir view.

4.9. Проверка работоспособности
Отправляйте письмо через "Деловая почта" и текстовое сообщение через ViPNet Client, проверяйте доставку.

##########################################################################

1. Настройка ViPNet (на основе методички с GitHub)

1.1. Предварительные шаги
Синхронизация времени: Убедитесь, что время на всех виртуальных машинах (ВМ) синхронизировано.
Firewall: Отключите или настройте брандмауэр для взаимодействия между ВМ.
Подключение координатора:
Вход: логин user, пароль user, выбор 1 (CLI), выбор 2 это графический интерфейс, лучше выбрать его

1.2. Установка необходимого ПО на Net1-AdminCA
SQL Server:
Устанавливайте SQL Server 2014
Выбирайте New SQL Server stand-alone installation or add features to an existing installation.
Принимайте лицензию (I accept the license terms), нажимайте Next трижды до Feature Selection.
Выбирайте все функции, задавайте имя экземпляра WINNCCSQL.
В Server Configuration для SQL Server Browser устанавливайте Startup Type: Automatic.
В Database Engine Configuration:
Режим аутентификации: Mixed Mode, задавайте пароль (например, xxXX1234).
Во вкладке FILESTREAM включайте все галочки.
В SQL Server Network Configuration > Protocols for WINNCCSQL > TCP/IP > Enabled: Yes, перезапускайте службу через SQL Server Services > Restart.
Visual C++:
Устанавливайте Microsoft Visual C++ Redistributable 2013 и 2015 с установочного диска (например, vcredist_x86_2013.exe, vcredist_x86_2015.exe).
Запускайте установщики, соглашайтесь с лицензией, завершайте установку.
ViPNet ЦУС и УКЦ:
Запускайте установщик ЦУС (например, ViPNet Administrator.exe).
Указывайте сервер: 172.16.1.3\WINNCCSQL, логин sa, пароль xxXX1234.

1.3. Создание структуры сети в ЦУС
Координаторы:
В ЦУС: "Координаторы" > "Новый координатор".
Задавайте имя (например, Coordinator1), режим работы — "Выполняет функции VPN-сервера".
В свойствах удаляйте все роли, добавляйте Coordinator HW-VA.
Межсерверные каналы:
В свойствах координатора: "Межсерверные каналы" > "Добавить", выбирайте другой координатор.
Клиенты:
"Клиенты" > "Создать новый сетевой узел", задавайте имя (например, Client1), выбирайте координатор.
Для узла OperCA добавляйте роль Registration Point.
Пользователи:
"Пользователи" > "Создать нового пользователя", выбирайте узел, задавайте имя (например, User1).
Связывайте пользователей через "Свойства" > "Связи с пользователями" > "Добавить".
Экспорт структуры:
"Моя сеть" > "Сохранить отчет о структуре сети в файл" > формат HTML.

1.4. Выпуск сертификатов и инициализация
Выпуск дистрибутивов:
В УКЦ: "Сетевые узлы" > выделите узлы > "Выдать новый дистрибутив ключей".
Задавайте пароль для каждого узла (например, RemoteOfficeN), сохраняйте .dst на USB.
Инициализация координатора HW100:
Подключите USB с .dst, выберите u (USB) на запросе [t/u/c].
Вводите пароль пользователя (например, RemoteOfficeN), затем пароль администратора из дистрибутива.
Настраивайте интерфейсы:
Configure interface eth0? [Yes/No]: Yes, выбирайте Static IP.
Задавайте IP (например, 192.168.1.2), маску (255.255.255.0), шлюз (например, 192.168.1.1).
Для других интерфейсов (например, eth1) выбирайте No или настраивайте по схеме.
Отключайте лишние функции (DNS, NTP) — отвечайте No, запускайте VPN службы (Yes).
Инициализация клиентов:
В ViPNet Client: "Настройка" > "Установить ключи", указывайте путь к .dst с USB.

1.5. Настройка фильтров
В ViPNet Client на сервере ЦУС:
"Сетевые фильтры" > "Фильтры открытой сети" > "Создать".
Действие: "Пропускать трафик", применяйте.

1.6. Межсетевое взаимодействие
Инициатор:
В ЦУС: "Доверенные сети" > "Установить взаимодействие" > "Я инициатор".
Задавайте номер сети (например, 12845), имя (Сеть 2), выбирайте координатор.
Добавляйте узлы и пользователей ("все со всеми"), сохраняйте межсетевую информацию.
Ключи:
В УКЦ: "Асимметричные мастер-ключи" > "Создать" > алгоритм ГОСТ Р 34.10-2001 EDH.
Экспортируйте ключ, передайте во вторую сеть.
Принимающая сеть:
В ЦУС: "Доверенные сети" > "Я принимаю файл", загружайте межсетевую информацию.
В УКЦ: "Администрирование" > импортируйте сертификат, в "Межсетевые мастер-ключи" загружайте ключ и используйте ("Использовать" > "Да").
Связь пользователей:
"Свойства пользователя" > "Связи с пользователями" > добавляйте из доверенной сети.

1.7. Туннелирование
На координаторах:
"Туннелирование" > "Добавить", указывайте IP незащищенного узла (например, 192.168.2.10).
Максимум туннелей: 30, применяйте.

1.8. Проверка работоспособности
Координатор HW100:
Статус: service show — ищите VPN service is running.
Интерфейсы: ifconfig — проверяйте eth0 с заданным IP.
Пинг: ping <IP> (например, ping 192.168.1.1).
Клиент:
Отправляйте письмо через "Деловая почта" и сообщение через ViPNet Client.
Журнал IP-пакетов:
Через веб-интерфейс: http://<ip-координатора>:8080.
Через CLI: iplir view.

1.9. Полезные команды для HW100
Вход в CLI: логин user, пароль user, выбор 1.
Версия ПО: отображается при входе (например, ViPNet Coordinator HW100 4.3.2-3421).
Перезагрузка: reboot.
Выключение: shutdown или кратковременное нажатие кнопки питания.

1.10. Модификация сети
Добавляйте узел и пользователя в ЦУС, выдавайте новый .dst.
Связывайте пользователей, отправляйте письмо и сообщение, проверяйте журналы.
